name: Zephyr

on:
  workflow_call:
    inputs:
      devcontainer-tag:
        description: The container tag to be used
        default: latest
        required: false
        type: string
      ref:
        type: string
        required: true

jobs:
  build-zephyr:
    name: Zephyr build
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}/devcontainer-zephyr:${{ inputs.devcontainer-tag }}
    strategy:
      matrix:
        board:
          - pico_plus2/rp2350b/m33
        app:
          - src/samples/mini/zephyr
          - src/samples/demo/zephyr
          - src/samples/supervisor/zephyr
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Configure West SDK
        run: cp -r /home/ocre-dev/.cmake ~

      - name: West init
        run: |
          . /home/ocre-dev/.venv/bin/activate
          west init -l .

      - name: West update
        run: |
          . /home/ocre-dev/.venv/bin/activate
          west update

      - name: West build
        run: |
          . /home/ocre-dev/.venv/bin/activate
          west build -p always -b ${{ matrix.board }} ${{ matrix.app }}

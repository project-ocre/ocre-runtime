#include <zephyr/dt-bindings/pinctrl/stm32-pinctrl.h>

/ {
    aliases {
        psram0 = &psram;
        rng0 = &rng_device;
        led0 = &green_led_1;
		led1 = &red_led_1;
    };

    leds {
		compatible = "gpio-leds";
		green_led_1: led_1 {
			gpios = <&gpioh 7 GPIO_ACTIVE_LOW>;
			label = "User LD7";
		};
		red_led_1: led_3 {
			gpios = <&gpioh 6 GPIO_ACTIVE_LOW>;
			label = "User LD6";
		};
	};

	gpio_keys {
		compatible = "gpio-keys";
		user_button: button {
			label = "User";
			gpios = <&gpioc 13 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
			zephyr,code = <INPUT_KEY_0>;
		};
	};

    rng_device: rng_0 {
        compatible = "custom,rng-sensor";
        label = "RNG Sensor";
        status = "okay";
    };

    devices {
        compatible = "custom,devices";
        status = "okay";
        device_list = <&rng_device &ism330dhcx &lps22hh &hts221 &iis2mdc &veml6030>;
    };

    reserved-memory {
        #address-cells = <1>;
        #size-cells = <1>;
        ranges;

        psram0: psram@90000000 {
            compatible = "zephyr,memory-region";
            reg = <0x90000000 0x00800000>;
            zephyr,memory-region = "PSRAM";
        };
    };

    chosen {
        zephyr,memory-region = &psram0;
    };
};

&octospi1 {
    status = "okay";
    pinctrl-0 = <&octospi1_clk &octospi1_ncs &octospi1_dqs 
                 &octospi1_io0 &octospi1_io1 &octospi1_io2 &octospi1_io3
                 &octospi1_io4 &octospi1_io5 &octospi1_io6 &octospi1_io7>;
    pinctrl-names = "default";

    psram: psram@0 {
        compatible = "st,stm32-ospi-psram";
        reg = <0x0 0x00800000>;
        st,ospi-mode = <3>;          // Octal mode
        st,ospi-clk-frequency = <104>;  // MHz
        st,ospi-chip-select = <0>;   // CS0
    };
};

/* OCTOSPI1 pinmux setup */
&pinctrl {
    octospi1_clk: octospi1_clk {
        pinmux = <STM32_PINMUX('E', 10, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_ncs: octospi1_ncs {
        pinmux = <STM32_PINMUX('E', 11, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_dqs: octospi1_dqs {
        pinmux = <STM32_PINMUX('E', 12, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io0: octospi1_io0 {
        pinmux = <STM32_PINMUX('E', 7, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io1: octospi1_io1 {
        pinmux = <STM32_PINMUX('E', 8, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io2: octospi1_io2 {
        pinmux = <STM32_PINMUX('E', 9, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io3: octospi1_io3 {
        pinmux = <STM32_PINMUX('E', 13, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io4: octospi1_io4 {
        pinmux = <STM32_PINMUX('E', 14, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io5: octospi1_io5 {
        pinmux = <STM32_PINMUX('E', 15, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io6: octospi1_io6 {
        pinmux = <STM32_PINMUX('E', 2, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };

    octospi1_io7: octospi1_io7 {
        pinmux = <STM32_PINMUX('D', 7, AF10)>;
        bias-disable;
        drive-push-pull;
        slew-rate = "very-high-speed";
    };
};

// Add labels for sensors defined in the board .dtsi file, and any other user configuration
// This is required so we can reference them in the devices block above, which is used by ocre_sensors
&i2c2 {
    ism330dhcx: ism330dhcx@6b { 
        label = "imu";
        status = "okay";
        accel-odr = <4>;    // 104 Hz
        accel-range = <4>;  // ±4 g
        gyro-odr = <4>;     // 104 Hz
        gyro-range = <250>; // ±250 dps
    };
    lps22hh: lps22hh@5d { 
        label = "pressure";
        status = "okay";
    };
    hts221: hts221@5f { 
        label = "humidity";
        status = "okay";
    };
    iis2mdc: iis2mdc@1e { 
        label = "magnetometer";
        status = "okay";
    };
    veml6030: veml6030@10 { 
        label = "light";
        status = "okay";
    };
};

&spi1 {
    eth0: ethernet@0 {
        status = "okay";
        reg = <0>;
        // W5500 Ethernet Shield
        compatible = "wiznet,w5500";
        int-gpios = <&gpiod 15 GPIO_ACTIVE_LOW>;
        spi-max-frequency = <32000000>;
        local-mac-address = [ 00 80 00 01 02 03 ];
    };
};

/* Optional: flash partitions */
&flash0 {
    partitions {
        user_data_partition: partition@100000 {
            label = "user_data";
            reg = <0x00100000 DT_SIZE_K(256)>;
        };
    };
};

&die_temp {
    status = "disabled";
};

&adc1 {
    status = "disabled";
};

&vref1 {
    status = "disabled";
};

&vbat4 {
    status = "disabled";
};
